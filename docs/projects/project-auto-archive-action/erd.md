---
status: active
owner: repo-maintainers
created: 2025-10-24
lastUpdated: 2025-10-24
---

# Engineering Requirements Document â€” Project Auto Archive Action

Mode: Lite

## 1. Introduction/Overview

Automate project archival with a zero-touch GitHub Action that runs after PR merge. When a project is complete (all tasks checked, no carryovers, final summary written), the action automatically archives it to `_archived/<YYYY>/`, fixes broken links, updates the projects README, and auto-merges the changes.

**Current Pain**: Manually running archive scripts, fixing links, updating README, and committing changes is repetitive and easy to forget.

**Solution**: GitHub Action that detects completed projects, performs archival workflow, and auto-merges cleanup PR â€” similar to changesets/version bot.

## 2. Goals/Objectives

- **Zero-touch completion**: Merge final PR â†’ action handles everything
- **Batch efficiency**: Archive multiple completed projects in one PR
- **Link integrity**: Automatically fix broken links after moving to `_archived/`
- **Consistent naming**: Use current year for archive directory
- **Auto-merge**: PR merges automatically when CI passes (like changesets bot)

## 3. Functional Requirements

### 3.1 Completion Detection

Scan all projects in `docs/projects/*/` and identify completed projects using these criteria (ALL required):

1. **All tasks checked**: `tasks.md` has no unchecked `- [ ]` items in main task sections
2. **No pending carryovers**: Either no `## Carryovers` section exists, OR section exists but contains no unchecked items
3. **Final summary present**: `final-summary.md` file exists in project directory

Skip projects that don't meet all three criteria (no error, just skip).

### 3.2 Archive Workflow (per project)

For each completed project:

1. **Move to archive**: Use existing `.cursor/scripts/project-archive.sh --project <slug> --year $(date +%Y)`
2. **Update ERD status**: Set `status: completed` in the archived ERD's YAML front matter
3. **Fix broken links**: Run link fixer (see 3.3)
4. **Collect changes**: Stage all modifications for batch PR

### 3.3 Link Fixing

Create `.cursor/scripts/archive-fix-links.sh`:

**Inputs**:

- Old path: `docs/projects/<slug>`
- New path: `docs/projects/_archived/<YYYY>/<slug>`

**Logic**:

- Find all `.md` files in `docs/` and `.cursor/rules/` referencing old path
- Update relative links: `docs/projects/<slug>/` â†’ `docs/projects/_archived/<YYYY>/<slug>/`
- Update absolute references if any
- Report files modified

**Output**: List of fixed files (for PR description)

### 3.4 Projects README Update

After all archival operations:

- Run `.cursor/scripts/generate-projects-readme.sh`
- Include in the batch PR

### 3.5 PR Creation and Auto-Merge

**Branch**: `bot/auto-archive-<timestamp>` (e.g., `bot/auto-archive-2025-10-24-1234`)

**Commit Message**:

```
chore(projects): auto-archive completed projects

- Archived: <slug-1>, <slug-2>, ...
- Fixed <N> broken links
- Updated projects README

Auto-generated by project-auto-archive workflow
```

**PR Title**: `chore(projects): Auto-archive completed projects (<count>)`

**PR Body** (see 3.6)

**Labels**: `auto-merge`, `bot`, `project-lifecycle`

**Auto-merge**: Enable GitHub auto-merge when PR is created (merges when CI passes)

### 3.6 PR Description Template

```markdown
## Summary

Auto-archiving <count> completed project(s) to `docs/projects/_archived/<YYYY>/`.

## Archived Projects

- **<slug-1>** â€” <title-from-erd>
  - Tasks: <total> complete
  - Final summary: âœ…
  - Moved to: `_archived/<YYYY>/<slug-1>/`
- **<slug-2>** â€” <title>
  - ...

## Changes

- **Archived**: <count> projects
- **Links fixed**: <count> files updated
- **Projects README**: Regenerated (Active: <N>, Pending: <M>, Archived: <P>)

## Validation

- âœ… All tasks complete
- âœ… No pending carryovers
- âœ… Final summaries present
- âœ… Links validated post-move
- âœ… Projects README updated

## Files Changed

- `docs/projects/_archived/<YYYY>/<slug>/` â€” <count> files moved
- `docs/projects/README.md` â€” Regenerated
- `<other-files-with-link-fixes>` â€” Links updated

---

ðŸ¤– Auto-generated by `.github/workflows/project-auto-archive.yml`
```

## 4. Error Conditions (Workflow Fails)

The action MUST fail when:

1. **Archive script fails**: `.cursor/scripts/project-archive.sh` exits non-zero
2. **Link fixer fails**: Cannot parse or update links
3. **README generation fails**: `.cursor/scripts/generate-projects-readme.sh` errors
4. **Git conflicts**: Moving files causes conflicts
5. **PR creation fails**: GitHub API errors

On failure:

- Log detailed error
- Do NOT create PR
- Exit workflow with failure status
- GitHub will notify via failed check

## 5. Non-Functional Requirements

- **Performance**: Complete in < 2 minutes for batch of 5 projects
- **Idempotent**: Re-running on same projects is safe (no-op if already archived)
- **Atomic**: All-or-nothing per batch (if one project fails, don't create partial PR)
- **Transparent**: PR description clearly shows what changed and why

## 6. Dependencies

**Existing Scripts** (reuse):

- `.cursor/scripts/project-archive.sh` â€” Move project to `_archived/<YYYY>/`
- `.cursor/scripts/generate-projects-readme.sh` â€” Regenerate README
- `.cursor/scripts/project-lifecycle-validate-scoped.sh` â€” Validate project structure

**New Scripts** (create):

- `.cursor/scripts/archive-fix-links.sh` â€” Fix broken links after move
- `.cursor/scripts/archive-detect-complete.sh` â€” Detect completed projects (checks tasks, carryovers, final-summary)

**GitHub Token**: Requires `GITHUB_TOKEN` with permissions:

- `contents: write` (commit changes)
- `pull-requests: write` (create PR, enable auto-merge)

## 7. Acceptance Criteria

- [ ] Action runs on push to `main` after PR merge
- [ ] Correctly detects projects meeting all 3 completion criteria
- [ ] Archives multiple projects in single batch PR
- [ ] Fixes all broken links pointing to archived projects
- [ ] Regenerates projects README with accurate counts
- [ ] Creates PR with comprehensive description
- [ ] Enables auto-merge on created PR
- [ ] PR merges automatically when CI passes
- [ ] Failed archival operations do not create partial PRs
- [ ] Can handle 0 completed projects (no-op, exit gracefully)

## 8. Assistant Integration

**New workflow rule**: When final task is completed:

1. Assistant detects: last unchecked task about to be checked
2. Assistant prompts: "All tasks complete. Ready to write final summary for archival?"
3. On "yes": Generate `final-summary.md`
4. User merges PR
5. **Action takes over**: Auto-archive workflow runs, creates cleanup PR, auto-merges

Update `.cursor/rules/project-lifecycle.mdc` or create `.cursor/rules/project-auto-archive.mdc` with:

- Trigger: final task completion detection
- Required prompt: "Ready to write final summary?"
- Output: `docs/projects/<slug>/final-summary.md`
- Next: user merges â†’ action handles rest

## 9. Risks/Edge Cases

**Edge Cases**:

- **Multiple projects complete at once**: Batch into one PR âœ…
- **Project with no links to fix**: Skip link fixing, don't error âœ…
- **Archive directory doesn't exist**: Create `docs/projects/_archived/<YYYY>/` âœ…
- **Carryovers section exists but empty**: Allowed (section with no items = resolved) âœ…
- **Tasks file missing**: Skip (not a completable project) âœ…
- **Final summary malformed**: Don't block (presence check only, not content validation)

**Risks**:

- **Link fixing misses references**: Mitigation: Run `links-check.sh` in CI after PR created
- **Auto-merge on broken CI**: Mitigation: Auto-merge waits for required checks
- **Concurrent archival**: Mitigation: GitHub's branch protection prevents race conditions

## 10. Implementation Plan

**Phase 1: Scripts** (owner: assistant)

1. Create `archive-detect-complete.sh` (detect completed projects)
2. Create `archive-fix-links.sh` (fix broken links)
3. Add tests for both scripts

**Phase 2: Workflow** (owner: assistant) 4. Create `.github/workflows/project-auto-archive.yml` 5. Implement workflow logic (scan â†’ archive â†’ fix â†’ PR â†’ auto-merge) 6. Test on non-prod branch first

**Phase 3: Rules** (owner: assistant) 7. Update assistant rules to prompt for final summary when tasks complete 8. Document the automated workflow in project-lifecycle docs

**Phase 4: Validation** (owner: maintainer) 9. Manually complete a test project 10. Verify action runs correctly 11. Verify auto-merge completes

## 11. Related

- Similar pattern: `.github/workflows/changesets.yml` (auto-merge bot)
- Existing tools: `.cursor/scripts/project-archive-workflow.sh`
- Rules update: `.cursor/rules/project-lifecycle.mdc`
